<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>통합 운세 분석기 (ESM 전용)</title>
  <style>
    body { font-family: sans-serif; max-width: 800px; margin: auto; padding: 1em; }
    h1, h2 { text-align: center; }
    form > div { margin: 0.5em 0; }
    label { display: block; margin-bottom: 0.2em; }
    input, select, button { width: 100%; padding: 0.5em; font-size: 1em; }
    #result { margin-top: 2em; border-top: 1px solid #ddd; padding-top: 1em; }
    section { margin-bottom: 2em; }
    ul { padding-left: 1.2em; }
  </style>
</head>
<body>

  <h1>🔮 통합 운세 분석기</h1>
  <form id="birthForm">
    <div>
      <label>생년월일</label>
      <input type="date" name="birthDate" required>
    </div>
    <div>
      <label>출생 시간</label>
      <input type="time" name="birthTime" required>
    </div>
    <div>
      <label>출생지 (예: Seoul, Korea)</label>
      <input type="text" name="birthPlace" placeholder="City, Country" required>
    </div>
    <div>
      <label>성별</label>
      <select name="gender" required>
        <option value="male">남성</option>
        <option value="female">여성</option>
      </select>
    </div>
    <button type="submit">운세 분석하기</button>
  </form>

  <div id="result"></div>

  <script type="module">
    import {
      processor,
      moshier,
      constants
    } from 'https://cdn.jsdelivr.net/npm/ephemeris@0.1.0/dist/esm/ephemeris.mjs';

    // — 헬퍼 함수들 —
    const stems    = ["갑","을","병","정","무","기","경","신","임","계"];
    const branches = ["자","축","인","묘","진","사","오","미","신","유","술","해"];
    const zodiac   = [
      { name:"양자리", start: 0 },   { name:"황소자리", start:30 },
      { name:"쌍둥이자리", start:60 }, { name:"게자리",   start:90 },
      { name:"사자자리", start:120 }, { name:"처녀자리", start:150 },
      { name:"천칭자리", start:180 }, { name:"전갈자리", start:210 },
      { name:"사수자리", start:240 }, { name:"염소자리", start:270 },
      { name:"물병자리", start:300 }, { name:"물고기자리", start:330 }
    ];

    function getYearPillar(year) {
      const idx = (year - 4) % 60;
      return stems[idx % 10] + branches[idx % 12];
    }

    function getZodiacName(lon) {
      lon = ((lon % 360) + 360) % 360;
      for (let i = zodiac.length - 1; i >= 0; i--) {
        if (lon >= zodiac[i].start) return zodiac[i].name;
      }
      return zodiac[0].name;
    }

    function getLuckCycles(gender, birthYear) {
      const dir = gender === "male" ? 1 : -1;
      const base = (birthYear - 4) % 60;
      const cycles = [];
      for (let i = 1; i <= 8; i++) {
        const idx = (base + dir * i + 60) % 60;
        cycles.push(stems[idx % 10] + branches[idx % 12]);
      }
      return cycles;
    }

    async function geocode(place) {
      const res = await fetch(
        "https://nominatim.openstreetmap.org/search?" +
        new URLSearchParams({ q: place, format: "json", limit: 1 })
      );
      const arr = await res.json();
      if (!arr.length) throw new Error("출생지를 찾을 수 없습니다");
      return { lat: +arr[0].lat, lon: +arr[0].lon };
    }

    // — 폼 & 결과 바인딩 —
    const form      = document.getElementById("birthForm");
    const resultDiv = document.getElementById("result");

    form.addEventListener("submit", async e => {
      e.preventDefault();
      resultDiv.innerHTML = "<p>로딩 중…</p>";

      try {
        // 1) 입력 파싱
        const data      = new FormData(form);
        const [d, t, p, g] = [
          data.get("birthDate"),
          data.get("birthTime"),
          data.get("birthPlace"),
          data.get("gender")
        ];
        const [Y, M, D] = d.split("-").map(v=>+v);
        const [h, m]    = t.split(":").map(v=>+v);

        // 2) 좌표 변환
        const { lat, lon } = await geocode(p);

        // 3) Ephemeris 계산 준비
        constants.tlong = lon;
        constants.glat  = lat;
        processor.init();

        // 4) 주요 행성 위치 뽑고 별자리 판정
        const planets = ["sun","moon","mercury","venus","mars","jupiter","saturn"];
        const info = planets.map(name => {
          processor.calc({ year:Y, month:M, day:D, hours:h, minutes:m, seconds:0 },
                         moshier.body[name]);
          const lonDeg = moshier.body[name].position.longitude;
          return {
            name,
            deg: lonDeg.toFixed(2),
            sign: getZodiacName(lonDeg)
          };
        });

        // 5) 사주·대운 계산
        const yearPillar = getYearPillar(Y);
        const luckCycles = getLuckCycles(g, Y);

        // 6) 렌더링
        let html = `
          <section>
            <h2>1. 사주 (년주)</h2>
            <p>출생 연도 천간·지지: <strong>${yearPillar}</strong></p>
          </section>
          <section>
            <h2>2. 행성별 운세</h2>
            <ul>`;
        info.forEach(p => {
          html += `<li>🌟 ${p.name.toUpperCase()}: ${p.sign} (${p.deg}°)</li>`;
        });
        html += `</ul>
          </section>
          <section>
            <h2>3. 대운</h2>
            <ul>`;
        luckCycles.forEach((c,i) => {
          html += `<li>${(i+1)*10}대운: ${c}</li>`;
        });
        html += `</ul>
          </section>`;
        
        resultDiv.innerHTML = html;
      }
      catch(err) {
        resultDiv.innerHTML = `<p style="color:red;">오류: ${err.message}</p>`;
      }
    });
  </script>
</body>
</html>
