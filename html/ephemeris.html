<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>í†µí•© ìš´ì„¸ ë¶„ì„ê¸° (ESM ì „ìš©)</title>
  <style>
    body { font-family: sans-serif; max-width: 800px; margin: auto; padding: 1em; }
    h1, h2 { text-align: center; }
    form > div { margin: 0.5em 0; }
    label { display: block; margin-bottom: 0.2em; }
    input, select, button { width: 100%; padding: 0.5em; font-size: 1em; }
    #result { margin-top: 2em; border-top: 1px solid #ddd; padding-top: 1em; }
    section { margin-bottom: 2em; }
    ul { padding-left: 1.2em; }
  </style>
</head>
<body>

  <h1>ğŸ”® í†µí•© ìš´ì„¸ ë¶„ì„ê¸°</h1>
  <form id="birthForm">
    <div>
      <label>ìƒë…„ì›”ì¼</label>
      <input type="date" name="birthDate" required>
    </div>
    <div>
      <label>ì¶œìƒ ì‹œê°„</label>
      <input type="time" name="birthTime" required>
    </div>
    <div>
      <label>ì¶œìƒì§€ (ì˜ˆ: Seoul, Korea)</label>
      <input type="text" name="birthPlace" placeholder="City, Country" required>
    </div>
    <div>
      <label>ì„±ë³„</label>
      <select name="gender" required>
        <option value="male">ë‚¨ì„±</option>
        <option value="female">ì—¬ì„±</option>
      </select>
    </div>
    <button type="submit">ìš´ì„¸ ë¶„ì„í•˜ê¸°</button>
  </form>

  <div id="result"></div>

  <script type="module">
    import {
      processor,
      moshier,
      constants
    } from 'https://cdn.jsdelivr.net/npm/ephemeris@0.1.0/dist/esm/ephemeris.mjs';

    // â€” í—¬í¼ í•¨ìˆ˜ë“¤ â€”
    const stems    = ["ê°‘","ì„","ë³‘","ì •","ë¬´","ê¸°","ê²½","ì‹ ","ì„","ê³„"];
    const branches = ["ì","ì¶•","ì¸","ë¬˜","ì§„","ì‚¬","ì˜¤","ë¯¸","ì‹ ","ìœ ","ìˆ ","í•´"];
    const zodiac   = [
      { name:"ì–‘ìë¦¬", start: 0 },   { name:"í™©ì†Œìë¦¬", start:30 },
      { name:"ìŒë‘¥ì´ìë¦¬", start:60 }, { name:"ê²Œìë¦¬",   start:90 },
      { name:"ì‚¬ììë¦¬", start:120 }, { name:"ì²˜ë…€ìë¦¬", start:150 },
      { name:"ì²œì¹­ìë¦¬", start:180 }, { name:"ì „ê°ˆìë¦¬", start:210 },
      { name:"ì‚¬ìˆ˜ìë¦¬", start:240 }, { name:"ì—¼ì†Œìë¦¬", start:270 },
      { name:"ë¬¼ë³‘ìë¦¬", start:300 }, { name:"ë¬¼ê³ ê¸°ìë¦¬", start:330 }
    ];

    function getYearPillar(year) {
      const idx = (year - 4) % 60;
      return stems[idx % 10] + branches[idx % 12];
    }

    function getZodiacName(lon) {
      lon = ((lon % 360) + 360) % 360;
      for (let i = zodiac.length - 1; i >= 0; i--) {
        if (lon >= zodiac[i].start) return zodiac[i].name;
      }
      return zodiac[0].name;
    }

    function getLuckCycles(gender, birthYear) {
      const dir = gender === "male" ? 1 : -1;
      const base = (birthYear - 4) % 60;
      const cycles = [];
      for (let i = 1; i <= 8; i++) {
        const idx = (base + dir * i + 60) % 60;
        cycles.push(stems[idx % 10] + branches[idx % 12]);
      }
      return cycles;
    }

    async function geocode(place) {
      const res = await fetch(
        "https://nominatim.openstreetmap.org/search?" +
        new URLSearchParams({ q: place, format: "json", limit: 1 })
      );
      const arr = await res.json();
      if (!arr.length) throw new Error("ì¶œìƒì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
      return { lat: +arr[0].lat, lon: +arr[0].lon };
    }

    // â€” í¼ & ê²°ê³¼ ë°”ì¸ë”© â€”
    const form      = document.getElementById("birthForm");
    const resultDiv = document.getElementById("result");

    form.addEventListener("submit", async e => {
      e.preventDefault();
      resultDiv.innerHTML = "<p>ë¡œë”© ì¤‘â€¦</p>";

      try {
        // 1) ì…ë ¥ íŒŒì‹±
        const data      = new FormData(form);
        const [d, t, p, g] = [
          data.get("birthDate"),
          data.get("birthTime"),
          data.get("birthPlace"),
          data.get("gender")
        ];
        const [Y, M, D] = d.split("-").map(v=>+v);
        const [h, m]    = t.split(":").map(v=>+v);

        // 2) ì¢Œí‘œ ë³€í™˜
        const { lat, lon } = await geocode(p);

        // 3) Ephemeris ê³„ì‚° ì¤€ë¹„
        constants.tlong = lon;
        constants.glat  = lat;
        processor.init();

        // 4) ì£¼ìš” í–‰ì„± ìœ„ì¹˜ ë½‘ê³  ë³„ìë¦¬ íŒì •
        const planets = ["sun","moon","mercury","venus","mars","jupiter","saturn"];
        const info = planets.map(name => {
          processor.calc({ year:Y, month:M, day:D, hours:h, minutes:m, seconds:0 },
                         moshier.body[name]);
          const lonDeg = moshier.body[name].position.longitude;
          return {
            name,
            deg: lonDeg.toFixed(2),
            sign: getZodiacName(lonDeg)
          };
        });

        // 5) ì‚¬ì£¼Â·ëŒ€ìš´ ê³„ì‚°
        const yearPillar = getYearPillar(Y);
        const luckCycles = getLuckCycles(g, Y);

        // 6) ë Œë”ë§
        let html = `
          <section>
            <h2>1. ì‚¬ì£¼ (ë…„ì£¼)</h2>
            <p>ì¶œìƒ ì—°ë„ ì²œê°„Â·ì§€ì§€: <strong>${yearPillar}</strong></p>
          </section>
          <section>
            <h2>2. í–‰ì„±ë³„ ìš´ì„¸</h2>
            <ul>`;
        info.forEach(p => {
          html += `<li>ğŸŒŸ ${p.name.toUpperCase()}: ${p.sign} (${p.deg}Â°)</li>`;
        });
        html += `</ul>
          </section>
          <section>
            <h2>3. ëŒ€ìš´</h2>
            <ul>`;
        luckCycles.forEach((c,i) => {
          html += `<li>${(i+1)*10}ëŒ€ìš´: ${c}</li>`;
        });
        html += `</ul>
          </section>`;
        
        resultDiv.innerHTML = html;
      }
      catch(err) {
        resultDiv.innerHTML = `<p style="color:red;">ì˜¤ë¥˜: ${err.message}</p>`;
      }
    });
  </script>
</body>
</html>
