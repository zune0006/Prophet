<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>í†µí•© ìš´ì„¸ ë¶„ì„ê¸°</title>
  <style>
    body { font-family: sans-serif; max-width: 800px; margin: auto; padding: 1em; }
    h1, h2 { text-align: center; }
    form > div { margin: 0.5em 0; }
    label { display: block; margin-bottom: 0.2em; }
    input, select, button { width: 100%; padding: 0.5em; font-size: 1em; }
    #result { margin-top: 2em; border-top: 1px solid #ddd; padding-top: 1em; }
    section { margin-bottom: 2em; }
    ul { padding-left: 1.2em; }
  </style>
</head>
<body>

  <h1>ğŸ”® í†µí•© ìš´ì„¸ ë¶„ì„ê¸°</h1>
  <form id="birthForm">
    <div>
      <label>ìƒë…„ì›”ì¼</label>
      <input type="date" name="birthDate" required>
    </div>
    <div>
      <label>ì¶œìƒ ì‹œê°„</label>
      <input type="time" name="birthTime" required>
    </div>
    <div>
      <label>ì¶œìƒì§€ (ì˜ˆ: Seoul, Korea)</label>
      <input type="text" name="birthPlace" placeholder="City, Country" required>
    </div>
    <div>
      <label>ì„±ë³„</label>
      <select name="gender" required>
        <option value="male">ë‚¨ì„±</option>
        <option value="female">ì—¬ì„±</option>
      </select>
    </div>
    <button type="submit">ìš´ì„¸ ë¶„ì„í•˜ê¸°</button>
  </form>

  <div id="result"></div>

  <!-- Moshier Ephemeris ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸° -->
  <script src="https://cdn.jsdelivr.net/gh/mivion/ephemeris@master/ephemeris-0.1.0.js"></script>

  <script>
/*
- Nominatim APIë¡œ ì¶œìƒì§€ë¥¼ ìœ„ë„Â·ê²½ë„ë¡œ ë³€í™˜
- Moshier Ephemeris (mivion/ephemeris)ë¡œ íƒœì–‘Â·ë‹¬Â·ìˆ˜ì„±Â·ê¸ˆì„±Â·í™”ì„±Â·ëª©ì„±Â·í† ì„±ì˜ í™©ë„ê²½ ê³„ì‚°
- í™©ë„ê²½ì„ ê¸°ë°˜ìœ¼ë¡œ ë³„ìë¦¬(12ê¶) íŒì •
- ì…ë ¥ ì—°ë„ë¡œ ë…„ì£¼(ì²œê°„Â·ì§€ì§€) ê³„ì‚°
- ì„±ë³„Â·ì¶œìƒ ì—°ë„ë¡œ ë‹¨ìˆœí™”í•œ 8ëŒ€ìš´ ê³„ì‚°
*/

    
  // HTML ìš”ì†Œ
  const form = document.getElementById("birthForm");
  const resultDiv = document.getElementById("result");

  // ì²œê°„Â·ì§€ì§€ ë°°ì—´
  const stems   = ["ê°‘","ì„","ë³‘","ì •","ë¬´","ê¸°","ê²½","ì‹ ","ì„","ê³„"];
  const branches= ["ì","ì¶•","ì¸","ë¬˜","ì§„","ì‚¬","ì˜¤","ë¯¸","ì‹ ","ìœ ","ìˆ ","í•´"];

  // í™©ë„ëŒ€ ë³„ìë¦¬ ë°°ì—´
  const zodiac = [
    { name:"ì–‘ìë¦¬", start: 0 },
    { name:"í™©ì†Œìë¦¬", start:30 },
    { name:"ìŒë‘¥ì´ìë¦¬", start:60 },
    { name:"ê²Œìë¦¬", start:90 },
    { name:"ì‚¬ììë¦¬", start:120 },
    { name:"ì²˜ë…€ìë¦¬", start:150 },
    { name:"ì²œì¹­ìë¦¬", start:180 },
    { name:"ì „ê°ˆìë¦¬", start:210 },
    { name:"ì‚¬ìˆ˜ìë¦¬", start:240 },
    { name:"ì—¼ì†Œìë¦¬", start:270 },
    { name:"ë¬¼ë³‘ìë¦¬", start:300 },
    { name:"ë¬¼ê³ ê¸°ìë¦¬", start:330 }
  ];

  // í–‰ì„±ë³„ í•´ì„ í‚¤ì›Œë“œ
  const planetMeanings = {
    sun:    "ìì•„ì™€ ê¸°ì§ˆ",
    moon:   "ê°ì •ê³¼ ë¬´ì˜ì‹",
    mercury:"ì‚¬ê³ ì™€ ì˜ì‚¬ì†Œí†µ",
    venus:  "ì‚¬ë‘ê³¼ ë¯¸ì  ê°ì„±",
    mars:   "í–‰ë™ë ¥ê³¼ ì¶”ì§„ë ¥",
    jupiter:"ì„±ì¥ê³¼ í–‰ìš´",
    saturn: "ì±…ì„ê³¼ ì¸ë‚´"
  };

  // ì²œê°„Â·ì§€ì§€ ê³„ì‚° (ë…„ì£¼)
  function getYearPillar(year){
    const i = (year - 4) % 60; 
    return stems[i % 10] + branches[i % 12];
  }

  // ë³„ìë¦¬ ê²°ì • (í™©ê²½ ê¸°ì¤€)
  function getZodiacName(lon){
    lon = (lon % 360 + 360) % 360;
    for(let i=zodiac.length-1; i>=0; i--){
      if(lon >= zodiac[i].start) return zodiac[i].name;
    }
    return zodiac[0].name;
  }

  // ëŒ€ìš´ ê³„ì‚° (ë‹¨ìˆœ ì˜ˆì‹œ)
  function getLuckCycles(gender, birthYear){
    const dir = (gender==="male")? 1 : -1;
    const base = (birthYear - 4) % 60;
    const cycles = [];
    for(let i=1; i<=8; i++){
      const idx = (base + dir*i + 60) % 60;
      cycles.push(stems[idx % 10] + branches[idx % 12]);
    }
    return cycles;
  }

  // Nominatimìœ¼ë¡œ ì§€ëª…â†’ìœ„ë„ê²½ë„
  async function geocode(place){
    const res = await fetch(
      "https://nominatim.openstreetmap.org/search?" +
      new URLSearchParams({ q:place, format:"json", limit:1 })
    );
    const j = await res.json();
    if(j.length===0) throw new Error("ìœ„ì¹˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
    return { lat:parseFloat(j[0].lat), lon:parseFloat(j[0].lon) };
  }

  form.addEventListener("submit", async e=>{
    e.preventDefault();
    resultDiv.innerHTML = "<p>ë¡œë”© ì¤‘â€¦</p>";

    try {
      // 1) ì…ë ¥ ì²˜ë¦¬
      const data = new FormData(form);
      const [dateStr, timeStr, place, gender] = [
        data.get("birthDate"),
        data.get("birthTime"),
        data.get("birthPlace"),
        data.get("gender")
      ];
      const [Y, M, D] = dateStr.split("-").map(x=>+x);
      const [h, m] = timeStr.split(":").map(x=>+x);

      // 2) geocode â†’ ìœ„ë„Â·ê²½ë„
      const {lat, lon} = await geocode(place);

      // 3) Ephemerisë¡œ í–‰ì„± ìœ„ì¹˜ ê³„ì‚°
      const astroDate = { year:Y, month:M, day:D, hours:h, minutes:m, seconds:0 };
      $const.tlong = lon;  
      $const.glat  = lat;  
      $processor.init();
      const bodies = ["sun","moon","mercury","venus","mars","jupiter","saturn"];
      const planetInfo = bodies.map(planet=>{
        $processor.calc(astroDate, $moshier.body[planet]);
        const pos = $moshier.body[planet].position;
        const sign = getZodiacName(pos.longitude);
        return {
          name: planet,
          lon: pos.longitude.toFixed(2),
          sign: sign,
          meaning: planetMeanings[planet]
        };
      });

      // 4) ì‚¬ì£¼(ë…„ì£¼)
      const yearPillar = getYearPillar(Y);

      // 5) ëŒ€ìš´
      const luck = getLuckCycles(gender, Y);

      // 6) ê²°ê³¼ ë Œë”ë§
      let html = "";
      // ì‚¬ì£¼
      html += `<section><h2>1. ì‚¬ì£¼ (ë…„ì£¼)</h2>
               <p>ì¶œìƒ ì—°ë„ì˜ ì²œê°„Â·ì§€ì§€: <strong>${yearPillar}</strong></p>
               </section>`;

      // í–‰ì„± ìš´ì„¸
      html += `<section><h2>2. í–‰ì„±ë³„ ìš´ì„¸</h2><ul>`;
      planetInfo.forEach(p=>{
        html += `<li>ğŸŒŸ ${p.name.toUpperCase()}: ${p.sign} (${p.lon}Â°) â€” ${p.meaning}ì— ì˜í–¥</li>`;
      });
      html += `</ul></section>`;

      // ëŒ€ìš´
      html += `<section><h2>3. ëŒ€ìš´</h2><ul>`;
      luck.forEach((c,i)=>{
        html += `<li>${(i+1)*10}ëŒ€ìš´: <strong>${c}</strong></li>`;
      });
      html += `</ul></section>`;

      resultDiv.innerHTML = html;
    }
    catch(err){
      resultDiv.innerHTML = `<p style="color:red;">ì˜¤ë¥˜: ${err.message}</p>`;
    }
  });
  </script>
</body>
</html>
