<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ğŸ”® ìˆœìˆ˜ ì›¹ ìš´ì„¸ ë³´ê¸°</title>
  <style>
    body { font-family: sans-serif; max-width:600px; margin:2em auto; }
    h1 { text-align:center; }
    form div { margin:0.5em 0; }
    label { display:block; margin-bottom:0.2em; }
    input, select, button { width:100%; padding:0.5em; font-size:1em; }
    #result { margin-top:2em; border-top:1px solid #ccc; padding-top:1em; }
    section { margin-bottom:1.5em; }
    ul { padding-left:1.2em; }
  </style>
  <!-- Mivion Ephemeris UMD ë¹Œë“œ (ì „ì—­ $const/$processor/$moshier ì œê³µ) -->
  <script src="https://cdn.jsdelivr.net/gh/mivion/ephemeris@master/ephemeris-0.1.0.js"></script>
</head>
<body>

  <h1>ğŸ”® ìˆœìˆ˜ ì›¹ ìš´ì„¸ ë³´ê¸°</h1>
  <form id="form">
    <div>
      <label>ìƒë…„ì›”ì¼</label>
      <input type="date" name="birthDate" required>
    </div>
    <div>
      <label>ì¶œìƒ ì‹œê°„</label>
      <input type="time" name="birthTime" required>
    </div>
    <div>
      <label>ì¶œìƒì§€ (ì˜ˆ: Seoul, Korea)</label>
      <input type="text" name="birthPlace" placeholder="City, Country" required>
    </div>
    <div>
      <label>ì„±ë³„</label>
      <select name="gender" required>
        <option value="male">ë‚¨ì„±</option>
        <option value="female">ì—¬ì„±</option>
      </select>
    </div>
    <button type="submit">ìš´ì„¸ ë³´ê¸°</button>
  </form>

  <div id="result"></div>

  <script>
  document.addEventListener('DOMContentLoaded',()=>{
    // ì²œê°„Â·ì§€ì§€
    const stems    = ["ê°‘","ì„","ë³‘","ì •","ë¬´","ê¸°","ê²½","ì‹ ","ì„","ê³„"];
    const branches = ["ì","ì¶•","ì¸","ë¬˜","ì§„","ì‚¬","ì˜¤","ë¯¸","ì‹ ","ìœ ","ìˆ ","í•´"];
    // 12ë³„ìë¦¬ í™©ê²½ êµ¬ê°„
    const zodiac = [
      {name:"ì–‘ìë¦¬",start:0},{name:"í™©ì†Œìë¦¬",start:30},
      {name:"ìŒë‘¥ì´ìë¦¬",start:60},{name:"ê²Œìë¦¬",start:90},
      {name:"ì‚¬ììë¦¬",start:120},{name:"ì²˜ë…€ìë¦¬",start:150},
      {name:"ì²œì¹­ìë¦¬",start:180},{name:"ì „ê°ˆìë¦¬",start:210},
      {name:"ì‚¬ìˆ˜ìë¦¬",start:240},{name:"ì—¼ì†Œìë¦¬",start:270},
      {name:"ë¬¼ë³‘ìë¦¬",start:300},{name:"ë¬¼ê³ ê¸°ìë¦¬",start:330}
    ];
    // ë…„ì£¼ ê³„ì‚°
    function getYearPillar(Y){
      const i = (Y - 4) % 60;
      return stems[i%10] + branches[i%12];
    }
    // í™©ë„ê²½â†’ë³„ìë¦¬ ì´ë¦„
    function getZodiac(lon){
      lon = (lon%360+360)%360;
      for(let i=zodiac.length-1;i>=0;i--){
        if(lon>=zodiac[i].start) return zodiac[i].name;
      }
      return zodiac[0].name;
    }
    // ëŒ€ìš´(ë‹¨ìˆœ: 10ì„¸ ë‹¨ìœ„, ì„±ë³„ì— ë”°ë¼ ì§„í–‰ë°©í–¥)
    function getLuckCycles(gender,Y){
      const dir = (gender==="male"?1:-1);
      const base = (Y-4)%60;
      return Array.from({length:8},(_,i)=>{
        const idx = (base + dir*(i+1) + 60)%60;
        return stems[idx%10] + branches[idx%12];
      });
    }
    // OpenStreetMap Nominatim ì§€ì˜¤ì½”ë”©
    async function geocode(place){
      const res = await fetch(
        "https://nominatim.openstreetmap.org/search?"
        + new URLSearchParams({q:place,format:"json",limit:1})
      );
      const arr = await res.json();
      if(!arr.length) throw new Error("ì¶œìƒì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
      return {lat:+arr[0].lat, lon:+arr[0].lon};
    }

    const form = document.getElementById("form");
    const result = document.getElementById("result");

    form.addEventListener("submit",async e=>{
      e.preventDefault();
      result.innerHTML = "<p>ë¡œë”© ì¤‘â€¦</p>";

      try {
        const fm = new FormData(form);
        const [d, t, place, gender] = [
          fm.get("birthDate"),
          fm.get("birthTime"),
          fm.get("birthPlace"),
          fm.get("gender")
        ];
        const [Y,M,D] = d.split("-").map(v=>+v);
        const [h,m]   = t.split(":").map(v=>+v);

        // 1) ì¶œìƒì§€ â†’ ìœ„ë„ê²½ë„
        const {lat,lon} = await geocode(place);

        // 2) Ephemeris ì„¸íŒ…
        $const.glat  = lat;
        $const.tlong = lon;
        $processor.init();

        // 3) ì£¼ìš” í–‰ì„± ê³„ì‚°
        const bodies = ["sun","moon","mercury","venus","mars","jupiter","saturn"];
        const info = bodies.map(b=>{
          $processor.calc(
            {year:Y,month:M,day:D,hours:h,minutes:m,seconds:0},
            $moshier.body[b]
          );
          const lonDeg = $moshier.body[b].position.longitude;
          return {name:b,lon:lonDeg.toFixed(2),sign:getZodiac(lonDeg)};
        });

        // 4) ì‚¬ì£¼Â·ëŒ€ìš´
        const yearPillar = getYearPillar(Y);
        const luckCycles = getLuckCycles(gender,Y);

        // 5) ê²°ê³¼ ë Œë”ë§
        let html = `
          <section>
            <h2>1. ì‚¬ì£¼ (ë…„ì£¼)</h2>
            <p>ì¶œìƒ ì—°ë„ ì²œê°„Â·ì§€ì§€: <strong>${yearPillar}</strong></p>
          </section>
          <section>
            <h2>2. í–‰ì„±ë³„ ë³„ìë¦¬ ìš´ì„¸</h2>
            <ul>`;
        info.forEach(p=>{
          html += `<li>ğŸŒŸ ${p.name.toUpperCase()}: ${p.sign} (${p.lon}Â°)</li>`;
        });
        html += `</ul></section>
          <section>
            <h2>3. ëŒ€ìš´ (10ì„¸ë§ˆë‹¤)</h2>
            <ul>`;
        luckCycles.forEach((c,i)=>{
          html += `<li>${(i+1)*10}ëŒ€ìš´: ${c}</li>`;
        });
        html += `</ul></section>`;

        result.innerHTML = html;
      }
      catch(ex){
        result.innerHTML = `<p style="color:red;">ì˜¤ë¥˜: ${ex.message}</p>`;
      }
    });
  });
  </script>
</body>
</html>
